{"componentChunkName":"component---src-templates-post-template-js","path":"/posts/2013020200/making-rubygems-local-mirror","result":{"data":{"markdownRemark":{"id":"18f345ed-61ca-5582-b221-75ae2620a9e3","html":"<p>仕事で開発をするときに、外部ネットワークとは隔離された環境でいろいろ作るというシチュエーションがけっこうあって、だいぶ前から欲しいと思っていた gem ファイルの local mirror を作ることにした。</p>\n<p>いくつかのサイトを見たけど、新しめに見えた下記の記述を参考に作業。</p>\n<ul>\n<li><a href=\"http://d.hatena.ne.jp/alunko/20100429/1272534777\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">gemサイトのローカルミラーの正しい作り方</a></li>\n</ul>\n<h2 id=\"準備\" style=\"position:relative;\"><a href=\"#%E6%BA%96%E5%82%99\" aria-label=\"準備 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>準備</h2>\n<p>Ruby をインストールして、gem コマンドを使えるようにする。</p>\n<p>次に rubygems-mirror をインストール。\ngem でも入れられるが、少しバージョンが古いようだった。\n今回は後述する変なはまり方をしたので、GitHub から並列度 (parallelism) 指定ができる版をダウンロードした。</p>\n<ul>\n<li><a href=\"https://github.com/rubygems/rubygems-mirror\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">rubygems/rubygems-mirror · GitHub</a></li>\n</ul>\n<p>gem mirror コマンドの設定ファイル、<code class=\"language-text\">~/.gem/.mirrorrc</code> を記述。\nこれも後述するはまりのため、最終的には下記の記述に落ち着いた。</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token punctuation\">-</span> <span class=\"token key atrule\">from</span><span class=\"token punctuation\">:</span> http<span class=\"token punctuation\">:</span>//production.s3.rubygems.org\n  <span class=\"token key atrule\">to</span><span class=\"token punctuation\">:</span> /path/to/gem/mirror\n  <span class=\"token key atrule\">parallelism</span><span class=\"token punctuation\">:</span> <span class=\"token number\">10</span></code></pre></div>\n<h2 id=\"ミラー開始\" style=\"position:relative;\"><a href=\"#%E3%83%9F%E3%83%A9%E3%83%BC%E9%96%8B%E5%A7%8B\" aria-label=\"ミラー開始 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ミラー開始</h2>\n<p>gem mirror コマンドを実行。</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">$ gem mirror\nFetching: http://production.s3.rubygems.org/specs.4.8.gz with <span class=\"token number\">10</span> threads\nTotal gems: <span class=\"token number\">263717</span>\nFetching <span class=\"token number\">263717</span> gems\n<span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span>.<span class=\"token punctuation\">(</span>略<span class=\"token punctuation\">)</span></code></pre></div>\n<p>いくつか存在しないファイルがあったが、一日ぐらいでミラー完了していた。</p>\n<p>下記のファイルを wget などで、ミラーしたディレクトリに直接取得。</p>\n<ul>\n<li>latest_specs.4.8.gz</li>\n<li>Marshal.4.8.Z</li>\n<li>specs.4.8.gz</li>\n<li>yaml</li>\n<li>quick/latest_index.rz</li>\n</ul>\n<p><code class=\"language-text\">quick/Marshal.4.8</code> ディレクトリを作成し、そこにすべての gemspec ファイルをダウンロードする。</p>\n<p>なにぶん量が多いので、参考にしたページが紹介していたスクリプトを少し変更して、ローカルの gem ファイルの方が新しい場合に gemspec ファイルを取得し直すようにした。\nこのままだと gemspec ファイルのみ差し替えがあった場合に対応できないが、上書き取得するオプションでもつけて、ときどき全部取得しなおすことにしよう。</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token comment\">#!/usr/bin/env ruby</span>\n<span class=\"token comment\"># -*- coding: utf-8 -*-</span>\n<span class=\"token keyword\">require</span> <span class=\"token string\">'net/http'</span>\n<span class=\"token constant\">VERBOSE</span><span class=\"token operator\">=</span><span class=\"token boolean\">false</span>\n<span class=\"token constant\">GEMSRC</span><span class=\"token operator\">=</span><span class=\"token string\">\"http://production.s3.rubygems.org:80\"</span>\n<span class=\"token constant\">BASEDIR</span><span class=\"token operator\">=</span><span class=\"token string\">\"/var/service/gem/mirror\"</span>\n<span class=\"token constant\">GEMDIR</span><span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token interpolation\"><span class=\"token delimiter tag\">#{</span><span class=\"token constant\">BASEDIR</span><span class=\"token delimiter tag\">}</span></span>/gems\"</span>\n<span class=\"token constant\">MARSHALDIR</span><span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token interpolation\"><span class=\"token delimiter tag\">#{</span><span class=\"token constant\">BASEDIR</span><span class=\"token delimiter tag\">}</span></span>/quick/Marshal.4.8\"</span>\n<span class=\"token keyword\">def</span> <span class=\"token method-definition\"><span class=\"token function\">fetch</span></span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">)</span>\n  response <span class=\"token operator\">=</span> <span class=\"token constant\">Net</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token constant\">HTTP</span><span class=\"token punctuation\">.</span>get_response<span class=\"token punctuation\">(</span><span class=\"token constant\">URI</span><span class=\"token punctuation\">.</span>parse<span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">case</span> response\n  <span class=\"token keyword\">when</span> <span class=\"token constant\">Net</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token constant\">HTTPSuccess</span>\n    response\n  <span class=\"token keyword\">when</span> <span class=\"token constant\">Net</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token constant\">HTTPRedirection</span>\n    fetch<span class=\"token punctuation\">(</span>response<span class=\"token punctuation\">[</span><span class=\"token string\">'Location'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">else</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">nil</span>\n  <span class=\"token keyword\">end</span>\n<span class=\"token keyword\">end</span>\nputs <span class=\"token string\">\"mirror src <span class=\"token interpolation\"><span class=\"token delimiter tag\">#{</span><span class=\"token constant\">GEMSRC</span><span class=\"token delimiter tag\">}</span></span>\"</span> <span class=\"token keyword\">if</span> <span class=\"token constant\">VERBOSE</span>\n<span class=\"token builtin\">Dir</span><span class=\"token punctuation\">.</span>foreach<span class=\"token punctuation\">(</span><span class=\"token constant\">GEMDIR</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">do</span> <span class=\"token operator\">|</span>gemfile<span class=\"token operator\">|</span>\n  <span class=\"token keyword\">next</span> <span class=\"token keyword\">if</span> <span class=\"token builtin\">File</span><span class=\"token punctuation\">.</span>ftype<span class=\"token punctuation\">(</span><span class=\"token string\">\"<span class=\"token interpolation\"><span class=\"token delimiter tag\">#{</span><span class=\"token constant\">GEMDIR</span><span class=\"token delimiter tag\">}</span></span>/<span class=\"token interpolation\"><span class=\"token delimiter tag\">#{</span>gemfile<span class=\"token delimiter tag\">}</span></span>\"</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token string\">'file'</span>\n  gemname <span class=\"token operator\">=</span> <span class=\"token builtin\">File</span><span class=\"token punctuation\">.</span>basename gemfile<span class=\"token punctuation\">,</span> <span class=\"token string\">'.gem'</span>\n  gemspecfile <span class=\"token operator\">=</span> gemname <span class=\"token operator\">+</span> <span class=\"token string\">'.gemspec.rz'</span>\n  marshalfile <span class=\"token operator\">=</span> <span class=\"token string\">\"<span class=\"token interpolation\"><span class=\"token delimiter tag\">#{</span><span class=\"token constant\">MARSHALDIR</span><span class=\"token delimiter tag\">}</span></span>/<span class=\"token interpolation\"><span class=\"token delimiter tag\">#{</span>gemspecfile<span class=\"token delimiter tag\">}</span></span>\"</span>\n  <span class=\"token keyword\">if</span> <span class=\"token builtin\">File</span><span class=\"token punctuation\">.</span>exist<span class=\"token operator\">?</span><span class=\"token punctuation\">(</span>marshalfile<span class=\"token punctuation\">)</span> <span class=\"token keyword\">and</span>\n     <span class=\"token builtin\">File</span><span class=\"token punctuation\">.</span>mtime<span class=\"token punctuation\">(</span><span class=\"token string\">\"<span class=\"token interpolation\"><span class=\"token delimiter tag\">#{</span><span class=\"token constant\">GEMDIR</span><span class=\"token delimiter tag\">}</span></span>/<span class=\"token interpolation\"><span class=\"token delimiter tag\">#{</span>gemfile<span class=\"token delimiter tag\">}</span></span>\"</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> <span class=\"token builtin\">File</span><span class=\"token punctuation\">.</span>mtime<span class=\"token punctuation\">(</span>marshalfile<span class=\"token punctuation\">)</span>\n    puts <span class=\"token string\">\"skip <span class=\"token interpolation\"><span class=\"token delimiter tag\">#{</span>gemspecfile<span class=\"token delimiter tag\">}</span></span>\"</span> <span class=\"token keyword\">if</span> <span class=\"token constant\">VERBOSE</span>\n    <span class=\"token keyword\">next</span>\n  <span class=\"token keyword\">end</span>\n  url <span class=\"token operator\">=</span> <span class=\"token string\">\"<span class=\"token interpolation\"><span class=\"token delimiter tag\">#{</span><span class=\"token constant\">GEMSRC</span><span class=\"token delimiter tag\">}</span></span>/quick/Marshal.4.8/<span class=\"token interpolation\"><span class=\"token delimiter tag\">#{</span>gemspecfile<span class=\"token delimiter tag\">}</span></span>\"</span>\n  puts <span class=\"token string\">\"fetch <span class=\"token interpolation\"><span class=\"token delimiter tag\">#{</span>gemspecfile<span class=\"token delimiter tag\">}</span></span>\"</span>\n  res <span class=\"token operator\">=</span> fetch<span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">if</span> res<span class=\"token punctuation\">.</span><span class=\"token keyword\">nil</span><span class=\"token operator\">?</span>\n    puts <span class=\"token string\">\"  ERROR: <span class=\"token interpolation\"><span class=\"token delimiter tag\">#{</span>url<span class=\"token delimiter tag\">}</span></span>\"</span>\n    <span class=\"token keyword\">next</span>\n  <span class=\"token keyword\">end</span>\n  <span class=\"token builtin\">File</span><span class=\"token punctuation\">.</span>open<span class=\"token punctuation\">(</span>marshalfile<span class=\"token punctuation\">,</span> <span class=\"token string\">'wb'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">do</span> <span class=\"token operator\">|</span>io<span class=\"token operator\">|</span>\n    io<span class=\"token punctuation\">.</span>write<span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">end</span>\n<span class=\"token keyword\">end</span>\n__END__</code></pre></div>\n<h2 id=\"ミラーサイト設定\" style=\"position:relative;\"><a href=\"#%E3%83%9F%E3%83%A9%E3%83%BC%E3%82%B5%E3%82%A4%E3%83%88%E8%A8%AD%E5%AE%9A\" aria-label=\"ミラーサイト設定 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ミラーサイト設定</h2>\n<p>Apache を設定し、上記でミラーを作ったディレクトリを公開する。</p>\n<div class=\"gatsby-highlight\" data-language=\"xml\"><pre class=\"language-xml\"><code class=\"language-xml\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>VirtualHost</span> <span class=\"token attr-name\"><span class=\"token namespace\">*:</span>80</span><span class=\"token punctuation\">></span></span>\n    ServerName rubygems.your.domain\n    DocumentRoot /path/to/gem/mirror\n    ErrorLog logs/rubygems-error_log\n    CustomLog logs/rubygems-access_log common\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>VirtualHost</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>gem コマンドの引数で上記のサーバを参照する。</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">gem <span class=\"token function\">install</span> -r --source http://rubygems.your.domain rails</code></pre></div>\n<p><code class=\"language-text\">~/.gemrc</code> に下記の内容を書いてもよい。</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">:sources</span><span class=\"token punctuation\">:</span>\n<span class=\"token punctuation\">-</span> http<span class=\"token punctuation\">:</span>//rubygems.your.domain</code></pre></div>\n<p>access_log に上記のアクセスが記録されれば OK。</p>\n<h2 id=\"はまった点\" style=\"position:relative;\"><a href=\"#%E3%81%AF%E3%81%BE%E3%81%A3%E3%81%9F%E7%82%B9\" aria-label=\"はまった点 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>はまった点</h2>\n<p>gem mirror コマンドがちゃんと動かず、しばらくはまりました。\n具体的にはこんな感じで、ミラーが途中で止まってしまう。</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">$ gem mirror\nFetching: http://rubygems.org/specs.4.8.gz with <span class=\"token number\">10</span> threads\nTotal gems:\nFetching <span class=\"token number\">263717</span> gems\n<span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span>.ERROR:  While executing gem <span class=\"token punctuation\">..</span>. <span class=\"token punctuation\">(</span>Gem::Mirror::Fetcher::Error<span class=\"token punctuation\">)</span>\n    unexpected response <span class=\"token comment\">#&lt;Net::HTTPServiceUnavailable 503 Service Temporarily Unavailable readbody=false></span>\n$ gem mirror\nFetching: http://rubygems.org/specs.4.8.gz with <span class=\"token number\">4</span> threads\nTotal gems: <span class=\"token number\">263717</span>\nFetching <span class=\"token number\">261349</span> gems\n.ERROR:  While executing gem <span class=\"token punctuation\">..</span>. <span class=\"token punctuation\">(</span>Gem::Mirror::Fetcher::Error<span class=\"token punctuation\">)</span>\n    unexpected response <span class=\"token comment\">#&lt;Net::HTTPServiceUnavailable 503 Service Temporarily Unavailable readbody=false></span></code></pre></div>\n<p>翌日、翌々日など試してみても同様の症状。\n調べてみても、rubygems.org がトラブっているような記事はみつからず。\n(乗っ取られたので、今日は見つかりそうですが…)</p>\n<p>そもそも、</p>\n<ul>\n<li>実行した直後は動いて、十数個で止まる</li>\n<li>連続して実行すると、すぐに弾かれる</li>\n<li>少し経ってからもう一度叩くと、いくつかは取得できる。</li>\n</ul>\n<p>…という状況から見て、なんらかの rate limit が効いているような気配。</p>\n<p>rubygems-mirror を調べてみると、gem install rubygems-mirror で入るバージョンにはない “parallelism” というオプションのあるバージョンが見つかった。\n並列度が高すぎると弾かれる問題なのかと考えて、そちらのバージョンをとってきて並列度を下げて実行しても症状変わらず。</p>\n<p>エラーメッセージを手がかりに探してみても、「サイトが落ちてたんだろ」的な過去のやりとりが引っかかる程度… と、そんな中でもいろいろ調べていたら手がかりになりそうな blog が見つかった。\n2012年9月〜11月ぐらいに tokyo-m.rubygems.org という、rubygems.org の日本向けサーバが落ちていたとのこと。\nそれぞれに問題の回避方法は違うものの、海外の Proxy を通すとか、リダイレクトされる s3 の URL を直接指定するとか、要するに tokyo-m.rubygems.org へのアクセスを避ける手段だった。</p>\n<p>blog の記述でも tokyo-m.rubygems.org は復旧済みのようだし、実際、今回 mirror を考えるまではまったく困っていなかった。\nしかしこれは試してみる価値あり… ということで、.gem/.mirrorrc に from: <a href=\"http://production.s3.rubygems.org\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">http://production.s3.rubygems.org</a> を指定すると… 動いたー！</p>\n<p>上記の挙動から考えて、</p>\n<ul>\n<li>tokyo-m.rubygems.org が落ちた (2012–09〜11 頃？)</li>\n<li>サーバを復旧させたが、そのときに rate limit をかけた</li>\n<li>普段使う分には問題ない設定だが、mirror のように連続して取得するとひっかかる</li>\n</ul>\n<p>ということだったんだろうと想像。\n日本語の gem mirror 記事はその時期以前のものばかりだったし、英語の gem mirror 記事で同じようなはまり方をしているのは見つからなかったので…</p>\n<p>自分だけがはまるとドキドキしますねぇ…^^;</p>","fields":{"slug":"/posts/2013020200/making-rubygems-local-mirror","tagSlugs":["/tag/ruby/","/tag/server/"]},"frontmatter":{"date":"2013-02-02T03:00:55.000Z","description":"仕事で開発をするときに、外部ネットワークとは隔離された環境でいろいろ作るというシチュエーションがけっこうあって、だいぶ前から欲しいと思っていた gem ファイルの local mirror を作ることにした。","tags":["Ruby","Server"],"title":"Ruby gem の local mirror を作る","socialImage":null}}},"pageContext":{"slug":"/posts/2013020200/making-rubygems-local-mirror"}},"staticQueryHashes":["251939775","401334301","825871152"]}