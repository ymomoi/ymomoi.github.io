{"componentChunkName":"component---src-templates-post-template-js","path":"/posts/2013022100/building-centos-rpm-local-mirror","result":{"data":{"markdownRemark":{"id":"badddfd6-7c32-5eb1-bf7c-7ee995d6c62f","html":"<p>外部ネットワークとは隔離された環境でいろいろ作業する時のために、だいぶ前から欲しいと思っていた rpm ファイルの local mirror も作ることにしました。</p>\n<p>…と言っても、調べてみたら作業自体はえらく簡単でした。こんなならもっと早くやっておけばよかった…^^;</p>\n<p>流れとしては「rsync で全ファイルを取得」「ディレクトリを httpd から見えるように設定」「ダウンロード先を local mirror に向ける」だけです。</p>\n<h2 id=\"rsync-で全ファイルを取得\" style=\"position:relative;\"><a href=\"#rsync-%E3%81%A7%E5%85%A8%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E5%8F%96%E5%BE%97\" aria-label=\"rsync で全ファイルを取得 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>rsync で全ファイルを取得</h2>\n<p>centos.org にある Mirror List から rsync をサポートしているホストを選び、近そうなところからダウンロードする。</p>\n<ul>\n<li><a href=\"http://www.centos.org/modules/tinycontent/index.php?id=32\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">CentOS Other Region’s Mirrors</a></li>\n</ul>\n<p>今回は IIJ の rsync ミラーを使うことにした。</p>\n<p>例えば下記のようなスクリプトで、rsync を使って必要なファイルを取得。</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token shebang important\">#!/bin/sh</span>\n<span class=\"token keyword\">for</span> <span class=\"token for-or-select variable\">ver</span> <span class=\"token keyword\">in</span> <span class=\"token number\">5.9</span> <span class=\"token number\">6.3</span>\n<span class=\"token keyword\">do</span>\n  <span class=\"token function\">rsync</span> -avSHP --verbose --delete <span class=\"token punctuation\">\\</span>\n    --exclude <span class=\"token string\">\"centosplus\"</span> <span class=\"token punctuation\">\\</span>\n    --exclude <span class=\"token string\">\"local*\"</span> <span class=\"token punctuation\">\\</span>\n    --exclude <span class=\"token string\">\"cr\"</span> <span class=\"token punctuation\">\\</span>\n    --exclude <span class=\"token string\">\"fasttrack\"</span> <span class=\"token punctuation\">\\</span>\n    --exclude <span class=\"token string\">\"isos\"</span> <span class=\"token punctuation\">\\</span>\n    rsync://ftp.iij.ad.jp/pub/linux/centos/<span class=\"token variable\">$ver</span>/ <span class=\"token punctuation\">\\</span>\n    ~/mirror/<span class=\"token variable\">$ver</span>/\n<span class=\"token keyword\">done</span>\n<span class=\"token builtin class-name\">exit</span> <span class=\"token number\">0</span></code></pre></div>\n<p>ファイルサイズはそれぞれこんな感じになった。\n6.3 の updates がけっこう大きいなぁ。</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">$ <span class=\"token function\">du</span> -hs <span class=\"token number\">5.9</span>/*\n84K     <span class=\"token number\">5.9</span>/addons\n346M    <span class=\"token number\">5.9</span>/centosplus\n84K     <span class=\"token number\">5.9</span>/contrib\n243M    <span class=\"token number\">5.9</span>/extras\n<span class=\"token number\">8</span>.6G    <span class=\"token number\">5.9</span>/os\n<span class=\"token number\">1</span>.2G    <span class=\"token number\">5.9</span>/updates\n$ <span class=\"token function\">du</span> -hs <span class=\"token number\">6.3</span>/*\n<span class=\"token number\">7</span>.9G    <span class=\"token number\">6.3</span>/centosplus\n84K     <span class=\"token number\">6.3</span>/contrib\n29M     <span class=\"token number\">6.3</span>/extras\n<span class=\"token number\">8</span>.7G    <span class=\"token number\">6.3</span>/os\n34G     <span class=\"token number\">6.3</span>/updates</code></pre></div>\n<h2 id=\"ディレクトリを公開\" style=\"position:relative;\"><a href=\"#%E3%83%87%E3%82%A3%E3%83%AC%E3%82%AF%E3%83%88%E3%83%AA%E3%82%92%E5%85%AC%E9%96%8B\" aria-label=\"ディレクトリを公開 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ディレクトリを公開</h2>\n<p>apache を設定。\n<code class=\"language-text\">Options +Indexes</code> は必要ない？かもしれないけど、あったほうが便利なので。</p>\n<div class=\"gatsby-highlight\" data-language=\"xml\"><pre class=\"language-xml\"><code class=\"language-xml\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>p</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>VirtualHost</span> <span class=\"token attr-name\"><span class=\"token namespace\">*:</span>80</span><span class=\"token punctuation\">></span></span>\n    ServerAdmin email@example.com\n    ServerName centos-mirror.example.com\n    DocumentRoot /your/mirror/dir\n    ErrorLog logs/centos-mirror-error_log\n    CustomLog logs/centos-mirror-access_log common\n    &lt;Directory /your/mirror/dir>\n        Options +Indexes\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>Directory</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>VirtualHost</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<h2 id=\"ダウンロード先を-local-mirror-にする\" style=\"position:relative;\"><a href=\"#%E3%83%80%E3%82%A6%E3%83%B3%E3%83%AD%E3%83%BC%E3%83%89%E5%85%88%E3%82%92-local-mirror-%E3%81%AB%E3%81%99%E3%82%8B\" aria-label=\"ダウンロード先を local mirror にする permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ダウンロード先を local mirror にする</h2>\n<p><code class=\"language-text\">/etc/yum.repos.d/CentOS-Base.repo</code> ファイルを書き換える。\n<code class=\"language-text\">mirrorlist=</code> 行をコメントアウトして、<code class=\"language-text\">baseurl=</code> 行を今回作ったサーバに向ける。</p>\n<p>apache で設定したパスがたどれるようにする。\nホスト名だけ書き換えたら見えるようにした方が楽でよさそうなので、ミラーディレクトリが <code class=\"language-text\">/centos</code> 以下に見えるように設定した。</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>base<span class=\"token punctuation\">]</span>\n<span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span>CentOS-<span class=\"token variable\">$releasever</span> - Base\n<span class=\"token comment\">#mirrorlist=http://mirrorlist.centos.org/?release=$releasever&amp;amp;arch=$basearch&amp;amp;repo=os</span>\n<span class=\"token assign-left variable\">baseurl</span><span class=\"token operator\">=</span>http://centos-mirror.example.com/centos/<span class=\"token variable\">$releasever</span>/os/<span class=\"token variable\">$basearch</span>/\n<span class=\"token assign-left variable\">gpgcheck</span><span class=\"token operator\">=</span><span class=\"token number\">1</span>\n<span class=\"token assign-left variable\">gpgkey</span><span class=\"token operator\">=</span>file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-6</code></pre></div>\n<p>簡単！</p>","fields":{"slug":"/posts/2013022100/building-centos-rpm-local-mirror","tagSlugs":["/tag/cent-os/"]},"frontmatter":{"date":"2013-02-21T19:20:44.000Z","description":"前から欲しいと思っていた rpm ファイルの local mirror も作ることにした。","tags":["CentOS"],"title":"CentOS の rpm local mirror を作る","socialImage":null}}},"pageContext":{"slug":"/posts/2013022100/building-centos-rpm-local-mirror"}},"staticQueryHashes":["251939775","401334301","825871152"]}